local Players = game:GetService('Players')
local ReplicatedStorage = game:GetService('ReplicatedStorage')
local RunService = game:GetService('RunService')
local UserInputService = game:GetService('UserInputService')
local TweenService = game:GetService('TweenService')

-- Переменные для хранения состояния
local originalCharacter = nil
local originalCameraSettings = {}
local isControlling = false
local countdownCoroutine = nil
local currentTools = {}
local originalHumanoidState = nil
local playerList = {}
local currentPlayerIndex = 1
local playerListUpdateInterval = 3
local webSlingerTool = nil
local controlTime = 8
local countdownStartTime = 0
local autoReturnConnection = nil

-- Цвета для GUI
local mainColor = Color3.fromRGB(25, 25, 25)
local accentColor = Color3.fromRGB(0, 255, 140)
local textColor = Color3.fromRGB(255, 255, 255)
local borderColor = Color3.fromRGB(50, 50, 50)
local cancelColor = Color3.fromRGB(255, 100, 100)
local headerColor = Color3.fromRGB(20, 20, 20)

-- Функция для получения отображаемого имени игрока (никнейм или логин)
local function getDisplayName(player)
    return player.DisplayName ~= '' and player.DisplayName or player.Name
end

-- Функция для обновления списка игроков
local function updatePlayerList()
    playerList = {}
    local localPlayer = Players.LocalPlayer

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character then
            table.insert(playerList, player)
        end
    end

    return playerList
end

-- Функция для остановки движения персонажа
local function stopCharacterMovement(character)
    if not character then
        return
    end

    local humanoid = character:FindFirstChild('Humanoid')
    local humanoidRootPart = character:FindFirstChild('HumanoidRootPart')

    if not humanoid or not humanoidRootPart then
        return
    end

    originalHumanoidState = {
        MoveDirection = humanoid.MoveDirection,
        WalkSpeed = humanoid.WalkSpeed,
    }

    humanoid:MoveTo(humanoidRootPart.Position)
    humanoid.WalkSpeed = 0
end

-- Функция для восстановления движения персонажа
local function restoreCharacterMovement(character)
    if not character or not originalHumanoidState then
        return
    end

    local humanoid = character:FindFirstChild('Humanoid')
    if not humanoid then
        return
    end

    humanoid.WalkSpeed = originalHumanoidState.WalkSpeed
    originalHumanoidState = nil
end

-- Функция для изменения WebRopes
local function modifyWebRopes()
    local workspaceObjects = workspace:GetDescendants()
    local modifiedCount = 0

    for _, object in ipairs(workspaceObjects) do
        if object:IsA('RopeConstraint') and object.Name:lower():find('web') then
            object.Length = 950
            modifiedCount = modifiedCount + 1
        end
    end

    return modifiedCount
end

-- Функция для сохранения текущих инструментов
local function saveCurrentTools()
    local localPlayer = Players.LocalPlayer
    local character = localPlayer.Character
    if not character then
        return
    end

    currentTools = {}
    for _, tool in ipairs(character:GetChildren()) do
        if tool:IsA('Tool') then
            table.insert(currentTools, tool:Clone())
        end
    end
end

-- Функция для восстановления инструментов
local function restoreTools()
    local localPlayer = Players.LocalPlayer
    local character = localPlayer.Character
    if not character then
        return
    end

    if webSlingerTool and webSlingerTool.Parent == character then
        webSlingerTool.Parent = localPlayer.Backpack
    end

    for _, tool in ipairs(character:GetChildren()) do
        if tool:IsA('Tool') then
            tool.Parent = localPlayer.Backpack
        end
    end

    for _, tool in ipairs(currentTools) do
        if tool and tool.Parent then
            local newTool = tool:Clone()
            newTool.Parent = character
        end
    end

    currentTools = {}
    webSlingerTool = nil
end

-- Функция для взятия Web Slinger в руки
local function takeWebSlinger()
    local localPlayer = Players.LocalPlayer
    local character = localPlayer.Character
    local backpack = localPlayer:FindFirstChild('Backpack')
    if not backpack or not character then
        return false
    end

    saveCurrentTools()

    for _, tool in ipairs(character:GetChildren()) do
        if tool:IsA('Tool') then
            tool.Parent = backpack
        end
    end

    webSlingerTool = nil
    for _, tool in ipairs(backpack:GetChildren()) do
        if
            tool:IsA('Tool')
            and (
                tool.Name:lower():find('web')
                or tool.Name:lower():find('slinger')
                or tool.Name:lower():find('shooter')
                or tool.Name:lower():find('swing')
            )
        then
            webSlingerTool = tool
            break
        end
    end

    if not webSlingerTool then
        restoreTools()
        return false
    end

    webSlingerTool.Parent = character
    wait(0.2)

    local humanoid = character:FindFirstChild('Humanoid')
    if humanoid then
        humanoid:EquipTool(webSlingerTool)
        wait(0.3)
        return true
    end

    return false
end

-- Функция для проверки расстояния до игрока
local function isPlayerInRange(targetPlayer, maxDistance)
    local localPlayer = Players.LocalPlayer
    local localCharacter = localPlayer.Character
    if not localCharacter then
        return false
    end

    local localRoot = localCharacter:FindFirstChild('HumanoidRootPart')
    if not localRoot then
        return false
    end

    if not targetPlayer or not targetPlayer.Character then
        return false
    end

    local targetRoot = targetPlayer.Character:FindFirstChild('HumanoidRootPart')
    if not targetRoot then
        return false
    end

    local distance = (localRoot.Position - targetRoot.Position).Magnitude
    return distance <= maxDistance
end

-- Функция для поиска ближайшего игрока в радиусе 20 studs
local function findNearestPlayerInRange()
    local localPlayer = Players.LocalPlayer
    local localCharacter = localPlayer.Character
    if not localCharacter then
        return nil
    end

    local localRoot = localCharacter:FindFirstChild('HumanoidRootPart')
    if not localRoot then
        return nil
    end

    local nearestPlayer = nil
    local shortestDistance = math.huge
    local maxDistance = 20

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character then
            local character = player.Character
            local humanoidRootPart =
                character:FindFirstChild('HumanoidRootPart')

            if humanoidRootPart then
                local distance = (
                    localRoot.Position - humanoidRootPart.Position
                ).Magnitude
                if distance < shortestDistance and distance <= maxDistance then
                    shortestDistance = distance
                    nearestPlayer = player
                end
            end
        end
    end

    return nearestPlayer
end

-- Функция для поиска игрока, в которого мы выстрелили
local function findShotPlayer()
    local localPlayer = Players.LocalPlayer

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character then
            local character = player.Character
            local humanoid = character:FindFirstChild('Humanoid')

            if humanoid and humanoid.PlatformStand then
                return player
            end
        end
    end

    return nil
end

-- Функция для отключения PlatformStand у цели
local function disablePlatformStand(targetPlayer)
    if targetPlayer and targetPlayer.Character then
        local humanoid = targetPlayer.Character:FindFirstChild('Humanoid')
        if humanoid then
            humanoid.PlatformStand = false
        end
    end
end

-- Функция для сменя персонажа
local function swapCharacter(targetPlayer)
    local localPlayer = Players.LocalPlayer

    originalCharacter = localPlayer.Character
    originalCameraSettings = {
        CameraType = workspace.CurrentCamera.CameraType,
        CameraSubject = workspace.CurrentCamera.CameraSubject,
    }

    stopCharacterMovement(originalCharacter)
    disablePlatformStand(targetPlayer)
    localPlayer.Character = targetPlayer.Character

    wait(0.5)

    workspace.CurrentCamera.CameraType = originalCameraSettings.CameraType
    if targetPlayer.Character:FindFirstChild('Humanoid') then
        workspace.CurrentCamera.CameraSubject = targetPlayer.Character.Humanoid
    end

    spawn(function()
        modifyWebRopes()
    end)
end

-- Функция для возврата к оригинальному персонажу
local function returnToOriginalCharacter()
    if not originalCharacter then
        return
    end

    local localPlayer = Players.LocalPlayer

    localPlayer.Character = originalCharacter
    restoreCharacterMovement(originalCharacter)

    workspace.CurrentCamera.CameraType = originalCameraSettings.CameraType
    if originalCharacter:FindFirstChild('Humanoid') then
        workspace.CurrentCamera.CameraSubject = originalCharacter.Humanoid
    end

    restoreTools()

    originalCharacter = nil
    originalCameraSettings = {}
    isControlling = false
    countdownStartTime = 0

    -- Отключаем автоматическое возвращение
    if autoReturnConnection then
        autoReturnConnection:Disconnect()
        autoReturnConnection = nil
    end
end

-- Функция для автоматического возврата через 10 секунд
local function setupAutoReturn()
    -- Отключаем предыдущее соединение, если оно есть
    if autoReturnConnection then
        autoReturnConnection:Disconnect()
    end

    -- Устанавливаем новое соединение для автоматического возврата
    autoReturnConnection = game:GetService('RunService').Heartbeat
        :Connect(function()
            if isControlling and originalCharacter then
                local elapsed = tick() - countdownStartTime
                if elapsed >= controlTime then
                    -- Автоматически возвращаемся через 10 секунд
                    returnToOriginalCharacter()
                    if controlButton then
                        controlButton.Text = 'Control Player (F)'
                        controlButton.TextColor3 = textColor
                        if controlButtonStroke then
                            controlButtonStroke.Color = borderColor
                        end
                    end
                end
            end
        end)
end

-- Функция для обновления текста кнопки с отсчетом времени
local function updateControlButtonText()
    if not isControlling or not controlButton then
        return
    end

    local elapsed = tick() - countdownStartTime
    local remaining = math.max(0, controlTime - elapsed)

    if remaining <= 0 then
        controlButton.Text = 'CANCEL (0s)'
        cancelControl()
    else
        controlButton.Text = 'CANCEL (' .. math.ceil(remaining) .. 's)'
    end
end

-- Функция для остановки таймера
local function stopCountdown()
    if countdownCoroutine then
        coroutine.close(countdownCoroutine)
        countdownCoroutine = nil
    end
end

-- Функция для отмены контроля
local function cancelControl()
    if isControlling then
        stopCountdown()
        returnToOriginalCharacter()
        if controlButton then
            controlButton.Text = 'Control Player (F)'
            controlButton.TextColor3 = textColor
            if controlButtonStroke then
                controlButtonStroke.Color = borderColor
            end
        end
        isControlling = false
    end
end

-- Функция AntihitFriend
local function antihitFriend(targetPlayer)
    if not targetPlayer or not targetPlayer.Character then
        warn('Целевой игрок не найден!')
        return false
    end

    if not isPlayerInRange(targetPlayer, 20) then
        warn('Целевой игрок слишком далеко!')
        return false
    end

    if not takeWebSlinger() then
        warn('Web Slinger не найден!')
        return false
    end

    local targetRoot = targetPlayer.Character:FindFirstChild('HumanoidRootPart')
    if not targetRoot then
        warn('У игрока нет HumanoidRootPart')
        return false
    end

    local Event = ReplicatedStorage.Packages.Net['RE/UseItem']
    Event:FireServer(
        Vector3.new(-450.30258178711, -7.0001068115234, 1.8120102882385),
        targetRoot
    )

    wait(0.5)
    disablePlatformStand(targetPlayer)

    spawn(function()
        modifyWebRopes()
    end)

    return true
end

-- Функция для выполнения Control Player
local function controlPlayer()
    if isControlling then
        cancelControl()
        return
    end

    local nearestPlayer = findNearestPlayerInRange()
    if not nearestPlayer then
        warn('Нет игроков в радиусе 20 studs!')
        return
    end

    if controlButton then
        controlButton.Text = 'Taking Web...'
    end

    if not takeWebSlinger() then
        if controlButton then
            controlButton.Text = 'No Web Slinger found!'
            wait(1)
            controlButton.Text = 'Control Player (F)'
        end
        warn('Web Slinger не найден!')
        return
    end

    if controlButton then
        controlButton.Text = 'Finding target...'
    end

    local targetRoot =
        nearestPlayer.Character:FindFirstChild('HumanoidRootPart')

    if targetRoot then
        if controlButton then
            controlButton.Text = 'Shooting...'
        end

        wait(0.3)

        local Event = ReplicatedStorage.Packages.Net['RE/UseItem']
        Event:FireServer(
            Vector3.new(-450.30258178711, -7.0001068115234, 1.8120102882385),
            targetRoot
        )

        if controlButton then
            controlButton.Text = 'Checking hit...'
        end

        wait(1.5)
        local shotPlayer = findShotPlayer()

        if shotPlayer then
            swapCharacter(shotPlayer)
            isControlling = true
            countdownStartTime = tick()

            if controlButton then
                controlButton.Text = 'CANCEL (' .. controlTime .. 's)'
                controlButton.TextColor3 = cancelColor
                if controlButtonStroke then
                    controlButtonStroke.Color = cancelColor
                end
            end

            -- Настраиваем автоматическое возвращение через 10 секунд
            setupAutoReturn()

            -- Запускаем отсчет времени для отображения в интерфейсе
            countdownCoroutine = coroutine.create(function()
                while isControlling do
                    updateControlButtonText()
                    if not isControlling then
                        break
                    end
                    wait(0.1)
                end
            end)
            coroutine.resume(countdownCoroutine)
        else
            warn('Промах! Не попали в игрока')
            restoreTools()
            if controlButton then
                controlButton.Text = 'Missed! Try again'
                wait(1)
                controlButton.Text = 'Control Player (F)'
            end
        end
    else
        warn('У игрока нет HumanoidRootPart')
        restoreTools()
        if controlButton then
            controlButton.Text = 'Target has no root part'
            wait(1)
            controlButton.Text = 'Control Player (F)'
        end
    end
end

-- Создание GUI
local player = Players.LocalPlayer
local screenGui = Instance.new('ScreenGui')
screenGui.Name = 'ControlPlayerMenu'
screenGui.Parent = player:WaitForChild('PlayerGui')
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- Основной контейнер с фоном
local mainContainer = Instance.new('Frame')
mainContainer.Name = 'MainContainer'
mainContainer.Size = UDim2.new(0, 170, 0, 230)
mainContainer.Position = UDim2.new(0, 10, 0, 20)
mainContainer.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainContainer.BackgroundTransparency = 0.3
mainContainer.BorderSizePixel = 0
mainContainer.Active = true
mainContainer.Draggable = false
mainContainer.Parent = screenGui

local uiCorner = Instance.new('UICorner')
uiCorner.CornerRadius = UDim.new(0, 8)
uiCorner.Parent = mainContainer

-- Область заголовка сверху
local headerFrame = Instance.new('Frame')
headerFrame.Size = UDim2.new(1, 0, 0, 30)
headerFrame.Position = UDim2.new(0, 0, 0, 0)
headerFrame.BackgroundColor3 = headerColor
headerFrame.BackgroundTransparency = 0.2
headerFrame.BorderSizePixel = 0
headerFrame.Parent = mainContainer

local headerCorner = Instance.new('UICorner')
headerCorner.CornerRadius = UDim.new(0, 8)
headerCorner.Parent = headerFrame

-- Текст заголовка
local headerLabel = Instance.new('TextLabel')
headerLabel.Size = UDim2.new(1, 0, 1, 0)
headerLabel.Position = UDim2.new(0, 0, 0, 0)
headerLabel.BackgroundTransparency = 1
headerLabel.Text = 'WEB CONTROL'
headerLabel.TextColor3 = accentColor
headerLabel.Font = Enum.Font.Code
headerLabel.TextSize = 16
headerLabel.TextStrokeTransparency = 0.8
headerLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
headerLabel.Parent = headerFrame

-- Внутренний контейнер для элементов
local contentContainer = Instance.new('Frame')
contentContainer.Size = UDim2.new(1, 0, 1, -30)
contentContainer.Position = UDim2.new(0, 0, 0, 30)
contentContainer.BackgroundTransparency = 1
contentContainer.Parent = mainContainer

-- Основная кнопка Control Player
local controlButton = Instance.new('TextButton')
controlButton.Size = UDim2.new(0, 150, 0, 40)
controlButton.Position = UDim2.new(0, 10, 0, 0)
controlButton.BackgroundColor3 = mainColor
controlButton.BorderSizePixel = 0
controlButton.Text = 'Control Player (F)'
controlButton.TextColor3 = textColor
controlButton.Font = Enum.Font.Code
controlButton.TextSize = 14
controlButton.Parent = contentContainer

local controlButtonCorner = Instance.new('UICorner')
controlButtonCorner.CornerRadius = UDim.new(0, 6)
controlButtonCorner.Parent = controlButton

local controlButtonStroke = Instance.new('UIStroke')
controlButtonStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
controlButtonStroke.Color = borderColor
controlButtonStroke.Thickness = 2
controlButtonStroke.LineJoinMode = Enum.LineJoinMode.Round
controlButtonStroke.Parent = controlButton

-- Кнопка Antihit Friend
local antihitButton = Instance.new('TextButton')
antihitButton.Size = UDim2.new(0, 150, 0, 40)
antihitButton.Position = UDim2.new(0, 10, 0, 50)
antihitButton.BackgroundColor3 = mainColor
antihitButton.BorderSizePixel = 0
antihitButton.Text = 'Antihit Friend (C)'
antihitButton.TextColor3 = textColor
antihitButton.Font = Enum.Font.Code
antihitButton.TextSize = 14
antihitButton.Parent = contentContainer

local antihitButtonCorner = Instance.new('UICorner')
antihitButtonCorner.CornerRadius = UDim.new(0, 6)
antihitButtonCorner.Parent = antihitButton

local antihitButtonStroke = Instance.new('UIStroke')
antihitButtonStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
antihitButtonStroke.Color = borderColor
antihitButtonStroke.Thickness = 2
antihitButtonStroke.LineJoinMode = Enum.LineJoinMode.Round
antihitButtonStroke.Parent = antihitButton

-- Текст для отображения выбранного игрока
local playerLabel = Instance.new('TextLabel')
playerLabel.Size = UDim2.new(0, 150, 0, 30)
playerLabel.Position = UDim2.new(0, 10, 0, 100)
playerLabel.BackgroundColor3 = mainColor
playerLabel.BackgroundTransparency = 0.5
playerLabel.BorderSizePixel = 0
playerLabel.Text = 'Players: 0'
playerLabel.TextColor3 = textColor
playerLabel.Font = Enum.Font.Code
playerLabel.TextSize = 12
playerLabel.Parent = contentContainer

local playerLabelCorner = Instance.new('UICorner')
playerLabelCorner.CornerRadius = UDim.new(0, 6)
playerLabelCorner.Parent = playerLabel

-- Кнопки для навигации по списку игроков
local prevButton = Instance.new('TextButton')
prevButton.Size = UDim2.new(0, 70, 0, 25)
prevButton.Position = UDim2.new(0, 10, 0, 140)
prevButton.BackgroundColor3 = mainColor
prevButton.BorderSizePixel = 0
prevButton.Text = '◀ Prev'
prevButton.TextColor3 = textColor
prevButton.Font = Enum.Font.Code
prevButton.TextSize = 12
prevButton.Parent = contentContainer

local prevButtonCorner = Instance.new('UICorner')
prevButtonCorner.CornerRadius = UDim.new(0, 6)
prevButtonCorner.Parent = prevButton

local nextButton = Instance.new('TextButton')
nextButton.Size = UDim2.new(0, 70, 0, 25)
nextButton.Position = UDim2.new(0, 90, 0, 140)
nextButton.BackgroundColor3 = mainColor
nextButton.BorderSizePixel = 0
nextButton.Text = 'Next ▶'
nextButton.TextColor3 = textColor
nextButton.Font = Enum.Font.Code
nextButton.TextSize = 12
nextButton.Parent = contentContainer

local nextButtonCorner = Instance.new('UICorner')
nextButtonCorner.CornerRadius = UDim.new(0, 6)
nextButtonCorner.Parent = nextButton

-- ========== ФУНКЦИЯ ПЕРЕТАСКИВАНИЯ ==========
local function setupDrag(frame)
    local dragging = false
    local dragStart, startPos

    -- Обработка начала перетаскивания
    local function onInputBegan(input)
        if
            input.UserInputType == Enum.UserInputType.MouseButton1
            or input.UserInputType == Enum.UserInputType.Touch
        then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
        end
    end

    -- Обработка изменения позиции
    local function onInputChanged(input)
        if
            dragging
            and (
                input.UserInputType == Enum.UserInputType.MouseMovement
                or input.UserInputType == Enum.UserInputType.Touch
            )
        then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end

    -- Обработка окончания перетаскивания
    local function onInputEnded(input)
        if
            input.UserInputType == Enum.UserInputType.MouseButton1
            or input.UserInputType == Enum.UserInputType.Touch
        then
            dragging = false
        end
    end

    -- Подключаем события
    frame.InputBegan:Connect(onInputBegan)
    frame.InputChanged:Connect(onInputChanged)

    UserInputService.InputChanged:Connect(onInputChanged)
    UserInputService.InputEnded:Connect(onInputEnded)
end

-- Настройка перетаскивания для основного контейнера
setupDrag(mainContainer)

-- Функция для обновления отображения выбранного игрока
local function updatePlayerDisplay()
    if #playerList == 0 then
        if playerLabel then
            playerLabel.Text = 'No players found'
        end
        return
    end

    local currentPlayer = playerList[currentPlayerIndex]
    if currentPlayer and playerLabel then
        local displayName = getDisplayName(currentPlayer)
        playerLabel.Text = string.format(
            '%d/%d: %s',
            currentPlayerIndex,
            #playerList,
            displayName
        )
    end
end

-- Функция для применения эффектов при наведении на кнопки
local function setupButtonHoverEffects(button)
    if not button then
        return
    end

    button.MouseEnter:Connect(function()
        TweenService:Create(
            button,
            TweenInfo.new(0.2),
            { BackgroundColor3 = Color3.fromRGB(35, 35, 35) }
        ):Play()
    end)

    button.MouseLeave:Connect(function()
        TweenService
            :Create(
                button,
                TweenInfo.new(0.2),
                { BackgroundColor3 = mainColor }
            )
            :Play()
    end)
end

-- Применяем эффекты ко всем кнопкам
setupButtonHoverEffects(controlButton)
setupButtonHoverEffects(antihitButton)
setupButtonHoverEffects(prevButton)
setupButtonHoverEffects(nextButton)

-- Инициализация списка игроков
updatePlayerList()
updatePlayerDisplay()

-- Запускаем периодическое обновление списка игроков
spawn(function()
    while true do
        wait(playerListUpdateInterval)
        updatePlayerList()
        if #playerList > 0 then
            currentPlayerIndex = math.min(currentPlayerIndex, #playerList)
            updatePlayerDisplay()
        end
    end
end)

-- Обработчики кнопок навигации
if prevButton then
    prevButton.MouseButton1Click:Connect(function()
        if #playerList > 0 then
            currentPlayerIndex = currentPlayerIndex - 1
            if currentPlayerIndex < 1 then
                currentPlayerIndex = #playerList
            end
            updatePlayerDisplay()
        end
    end)

    prevButton.TouchTap:Connect(function()
        if #playerList > 0 then
            currentPlayerIndex = currentPlayerIndex - 1
            if currentPlayerIndex < 1 then
                currentPlayerIndex = #playerList
            end
            updatePlayerDisplay()
        end
    end)
end

if nextButton then
    nextButton.MouseButton1Click:Connect(function()
        if #playerList > 0 then
            currentPlayerIndex = currentPlayerIndex + 1
            if currentPlayerIndex > #playerList then
                currentPlayerIndex = 1
            end
            updatePlayerDisplay()
        end
    end)

    nextButton.TouchTap:Connect(function()
        if #playerList > 0 then
            currentPlayerIndex = currentPlayerIndex + 1
            if currentPlayerIndex > #playerList then
                currentPlayerIndex = 1
            end
            updatePlayerDisplay()
        end
    end)
end

-- Функция для выполнения Antihit Friend
local function executeAntihitFriend()
    if #playerList == 0 then
        warn('Нет игроков для выбора!')
        return
    end

    local targetPlayer = playerList[currentPlayerIndex]
    if targetPlayer then
        if antihitButton then
            antihitButton.Text = 'Checking range...'
        end

        if not isPlayerInRange(targetPlayer, 20) then
            if antihitButton then
                antihitButton.Text = 'Too far!'
                wait(1)
                antihitButton.Text = 'Antihit Friend (C)'
            end
            warn('Целевой игрок слишком далеко!')
            return
        end

        if antihitButton then
            antihitButton.Text = 'Shooting...'
        end

        if antihitFriend(targetPlayer) then
            if antihitButton then
                antihitButton.Text = 'Success!'
                wait(1)
                antihitButton.Text = 'Antihit Friend (C)'
            end
        else
            if antihitButton then
                antihitButton.Text = 'Failed!'
                wait(1)
                antihitButton.Text = 'Antihit Friend (C)'
            end
        end
    end
end

-- Обработчик кнопки Antihit Friend
if antihitButton then
    antihitButton.MouseButton1Click:Connect(function()
        executeAntihitFriend()
    end)

    antihitButton.TouchTap:Connect(function()
        executeAntihitFriend()
    end)
end

-- Обработчик основной кнопки Control Player
if controlButton then
    controlButton.MouseButton1Click:Connect(function()
        controlPlayer()
    end)

    controlButton.TouchTap:Connect(function()
        controlPlayer()
    end)
end

-- Бинды клавиш (только для ПК)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then
        return
    end

    if input.KeyCode == Enum.KeyCode.F then
        controlPlayer()
    end

    if input.KeyCode == Enum.KeyCode.C then
        executeAntihitFriend()
    end
end)

-- Очистка при выходе
player.CharacterRemoving:Connect(function()
    if isControlling then
        cancelControl()
    else
        restoreTools()
    end
end)

screenGui.Destroying:Connect(function()
    if isControlling then
        cancelControl()
    else
        restoreTools()
    end
end)

return {
    Toggle = function(state)
        screenGui.Enabled = state
    end,
    ShowUI = function()
        screenGui.Enabled = true
    end,
    HideUI = function()
        screenGui.Enabled = false
    end,
    ToggleUI = function(state)
        screenGui.Enabled = state
    end
}
