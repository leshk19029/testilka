-- Функция для генерации HWID
local function generateHWID()
    local hwid = ''
    local success, result = pcall(function()
        return game:GetService('RbxAnalyticsService'):GetClientId()
    end)

    if success and result then
        hwid = tostring(result)
    else
        hwid = game:GetService('HttpService'):GenerateGUID(false)
    end
    return hwid
end

-- Функция для отправки ошибок в вебхук
local function sendWebhook(hwid, success, message)
    local request = (syn and syn.request)
        or (http and http.request)
        or http_request
        or (fluxus and fluxus.request)
        or request
    if not request then
        return false
    end

    local statusText = success and 'УСПЕШНЫЙ ВХОД'
        or 'ОШИБКА ДОСТУПА'
    local color = success and 65280 or 16711680

    local webhookData = {
        embeds = {
            {
                title = statusText,
                color = color,
                fields = {
                    {
                        name = 'Игрок',
                        value = game.Players.LocalPlayer.Name,
                        inline = true,
                    },
                    {
                        name = 'User ID',
                        value = tostring(game.Players.LocalPlayer.UserId),
                        inline = true,
                    },
                    { name = 'HWID', value = hwid or 'N/A', inline = false },
                    {
                        name = 'Сообщение',
                        value = message
                            or 'Нет дополнительной информации',
                        inline = false,
                    },
                    {
                        name = 'Время',
                        value = os.date('%Y-%m-%d %H:%M:%S'),
                        inline = true,
                    },
                },
                footer = { text = 'PURY system' },
                timestamp = os.date('!%Y-%m-%dT%H:%M:%SZ'),
            },
        },
    }

    if not success then
        webhookData.content =
            'Попытка несанкционированного доступа'
    end

    local success, result = pcall(function()
        local response = request({
            Url = 'https://discord.com/api/webhooks/1417570852202872838/QLvoA_0YinwQldMgTTHQvoM0r2HlqellWJlzNNlQYSDX4H-0IwMGF8CV4YDOHIzrNhU-',
            Method = 'POST',
            Headers = { ['Content-Type'] = 'application/json' },
            Body = game:GetService('HttpService'):JSONEncode(webhookData),
        })
        return response
    end)

    return success
end

-- Функция для проверки лицензии
local function checkLicense(hwid)
    local databaseUrl =
        'https://raw.githubusercontent.com/leshk19029/sphirit/refs/heads/main/base'

    local success, data = pcall(function()
        return game:HttpGet(databaseUrl)
    end)

    if not success then
        sendWebhook(
            hwid,
            false,
            'Ошибка загрузки базы данных: '
                .. tostring(data)
        )
        return false, 'Ошибка загрузки базы данных'
    end

    local authorizedHWIDs = {}
    for line in data:gmatch('[^\r\n]+') do
        local authorizedHWID = line:match('^%s*(.-)%s*$')
        if authorizedHWID and authorizedHWID ~= '' then
            authorizedHWIDs[authorizedHWID] = true
        end
    end

    if authorizedHWIDs[hwid] then
        return true, 'Доступ разрешен'
    end

    return false, 'HWID не найден в базе'
end

-- Основная проверка лицензии
local function performLicenseCheck()
    local HWID = generateHWID()
    local isValid, message = checkLicense(HWID)
    sendWebhook(HWID, isValid, message)

    if not isValid then
        game.Players.LocalPlayer:Kick('KICKED BY MODERATORS: ' .. message)
        return false
    end

    return true
end

-- Выполняем проверку лицензии перед загрузкой интерфейса
if not performLicenseCheck() then
    return
end

-- Проверка при каждом спавне персонажа
game.Players.LocalPlayer.CharacterAdded:Connect(function()
    task.spawn(function()
        if not performLicenseCheck() then
            return
        end
    end)
end)

-- Если проверка пройдена, загружаем интерфейс
local Library = loadstring(
    game:HttpGet(
        'https://raw.githubusercontent.com/leshk19029/testilka/refs/heads/main/library'
    )
)()

local SpeedBoostModule = loadstring(
    game:HttpGet(
        'https://raw.githubusercontent.com/leshk19029/testilka/refs/heads/main/speed'
    )
)()

-- Загружаем ESP модуль, но не инициализируем его сразу
local ESPModuleScript = game:HttpGet(
    'https://raw.githubusercontent.com/leshk19029/testilka/refs/heads/main/esp'
)

local AntiEffectsModule = loadstring(
    game:HttpGet(
        'https://raw.githubusercontent.com/leshk19029/testilka/refs/heads/main/antieffects'
    )
)()

local Window = Library:CreateMain({
    projName = 'pury',
    Resizable = true,
    MinSize = UDim2.new(0, 700, 0, 460),
    MaxSize = UDim2.new(0, 1000, 0, 600),
})

local MainTab = Window:CreateCategory('Main')
local MainSection = MainTab:CreateSection('Functions')

-- Anti Effects Toggle
local AntiEffectsToggle = MainSection:Create(
    'Toggle',
    'Anti effects',
    function(state)
        if state then
            AntiEffectsModule()
        end
    end,
    {
        default = false,
    }
)

-- Speed Boost Toggle
local SpeedBoostToggle = MainSection:Create(
    'Toggle',
    'Speed Boost',
    function(state)
        SpeedBoostModule:SetEnabled(state)
    end,
    {
        default = false,
    }
)

-- Speed Value Slider
local SpeedSlider = MainSection:Create('Slider', 'Speed value', function(value)
    SpeedBoostModule:SetSpeed(value)
    if SpeedBoostModule.Enabled then
        SpeedBoostModule:Disable()
        SpeedBoostModule:Enable()
    end
end, {
    min = 1,
    max = 45,
    default = 16,
    precise = true,
})

-- ESP Toggle с ленивой загрузкой
local ESPModule = nil
local espLoaded = false
local ESPToggle = MainSection:Create('Toggle', 'ESP', function(state)
    if state and not espLoaded then
        -- Загружаем ESP модуль только при первом включении
        ESPModule = loadstring(ESPModuleScript)()
        espLoaded = true
    end

    if espLoaded then
        ESPModule.ToggleAll(state)
    end
end, {
    default = false,
})

-- Float Toggle (ленивая загрузка)
local FloatModule = nil
local floatLoaded = false
local FloatToggle = MainSection:Create('Toggle', 'Float', function(state)
    if state and not floatLoaded then
        FloatModule = loadstring(
            game:HttpGet(
                'https://raw.githubusercontent.com/leshk19029/testilka/refs/heads/main/gravity'
            )
        )()
        floatLoaded = true
    end

    if floatLoaded then
        FloatModule:Toggle(state)
    end
end, {
    default = false,
})

-- FPS Devouver Toggle (ленивая загрузка)
local FPSDevouverModule = nil
local fpsDevouverLoaded = false
local FPSDevouverToggle = MainSection:Create(
    'Toggle',
    'FPS devouver',
    function(state)
        if state and not fpsDevouverLoaded then
            FPSDevouverModule = loadstring(
                game:HttpGet(
                    'https://raw.githubusercontent.com/leshk19029/testilka/refs/heads/main/fps'
                )
            )()
            fpsDevouverLoaded = true
        end

        if fpsDevouverLoaded then
            FPSDevouverModule:Toggle(state)
        end
    end,
    {
        default = false,
    }
)

-- Invisibility Steal Toggle - только управление видимостью UI модуля
local InvisibilityStealModule = nil
local invisibilityLoaded = false
local InvisibilityToggle = MainSection:Create(
    'Toggle',
    'Invisibility steal',
    function(state)
        if state and not invisibilityLoaded then
            -- Загружаем Invisibility Steal модуль с GitHub
            local success, module = pcall(function()
                return loadstring(
                    game:HttpGet(
                        'https://drive.google.com/uc?export=download&id=1qd-0Fpdg9Fxa-4YV2z5EQG8ClSEw1Uij'
                    )
                )()
            end)

            if success then
                InvisibilityStealModule = module
                invisibilityLoaded = true
                -- Показываем UI модуля
                if InvisibilityStealModule.ShowUI then
                    InvisibilityStealModule:ShowUI()
                end
            else
                InvisibilityToggle:SetState(false)
            end
        else
            if InvisibilityStealModule then
                -- Управляем только видимостью UI модуля
                if InvisibilityStealModule.ToggleUI then
                    InvisibilityStealModule:ToggleUI(state)
                elseif
                    InvisibilityStealModule.ShowUI
                    and InvisibilityStealModule.HideUI
                then
                    if state then
                        InvisibilityStealModule:ShowUI()
                    else
                        InvisibilityStealModule:HideUI()
                    end
                end
            end
        end
    end,
    {
        default = false,
    }
)

-- Web Control Toggle (ленивая загрузка)
local WebControlModule = nil
local webControlLoaded = false
local webControlScreenGui = nil
local lastWebControlPosition = UDim2.new(0, 10, 0, 15) -- Позиция по умолчанию

local WebControlToggle = MainSection:Create(
    'Toggle',
    'Web control',
    function(state)
        if state and not webControlLoaded then
            -- Загружаем Web Control модуль с GitHub
            local success, module = pcall(function()
                return loadstring(
                    game:HttpGet(
                        'https://drive.google.com/uc?export=download&id=1fYeGCKw4g8ouy0QTN3-V2cAysuNEFKaF'
                    )
                )()
            end)
            if success then
                WebControlModule = module
                webControlLoaded = true

                -- Сохраняем ссылку на ScreenGui для управления видимостью
                local player = game:GetService('Players').LocalPlayer
                webControlScreenGui =
                    player.PlayerGui:FindFirstChild('ControlPlayerMenu')

                if webControlScreenGui then
                    -- Восстанавливаем последнюю позицию
                    webControlScreenGui.MainContainer.Position =
                        lastWebControlPosition
                    webControlScreenGui.Enabled = true
                end
            else
                WebControlToggle:SetState(false)
            end
        else
            if webControlScreenGui then
                -- Сохраняем текущую позицию перед скрытием
                lastWebControlPosition =
                    webControlScreenGui.MainContainer.Position
                webControlScreenGui.Enabled = state
            elseif WebControlModule and webControlLoaded then
                -- Если ScreenGui был уничтожен, пересоздаем его
                local player = game:GetService('Players').LocalPlayer
                webControlScreenGui =
                    player.PlayerGui:FindFirstChild('ControlPlayerMenu')

                if webControlScreenGui then
                    webControlScreenGui.MainContainer.Position =
                        lastWebControlPosition
                    webControlScreenGui.Enabled = state
                else
                    -- Пересоздаем интерфейс
                    WebControlModule = loadstring(
                        game:HttpGet(
                            'https://raw.githubusercontent.com/leshk19029/testilka/refs/heads/main/webcontrol'
                        )
                    )()
                    webControlScreenGui =
                        player.PlayerGui:FindFirstChild('ControlPlayerMenu')
                    if webControlScreenGui then
                        webControlScreenGui.MainContainer.Position =
                            lastWebControlPosition
                    end
                end
            end
        end
    end,
    {
        default = false,
    }
)

-- Функция для сохранения позиции Web Control
local function saveWebControlPosition()
    if webControlScreenGui and webControlScreenGui.Enabled then
        lastWebControlPosition = webControlScreenGui.MainContainer.Position
    end
end

-- Периодически сохраняем позицию
spawn(function()
    while true do
        wait(5)
        saveWebControlPosition()
    end
end)

-- Сохраняем позицию при изменении
if webControlScreenGui then
    webControlScreenGui.MainContainer
        :GetPropertyChangedSignal('Position')
        :Connect(function()
            saveWebControlPosition()
        end)
end
